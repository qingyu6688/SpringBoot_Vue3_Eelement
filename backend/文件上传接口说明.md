# 文件上传接口说明

## 配置说明

### application.yml 配置
```yaml
# 文件上传配置
file:
  upload-path: D:/upload/  # 文件存储路径，可根据实际情况修改
  access-url: http://localhost:8080/  # 文件访问URL前缀
```

### 文件大小限制
- 单个文件最大：30MB
- 请求最大：30MB

## 接口列表

### 1. 文件上传
**接口地址：** `POST /api/file/upload`

**请求方式：** `multipart/form-data`

**请求参数：**
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| file   | File | 是   | 上传的文件 |

**响应示例：**
```json
{
  "code": 200,
  "message": "操作成功",
  "data": {
    "id": 1,
    "fileName": "test.jpg",
    "type": "jpg",
    "size": 1024,
    "url": "http://localhost:8080/abc123.jpg",
    "md5": "d41d8cd98f00b204e9800998ecf8427e",
    "enable": 1,
    "createTime": "2025-11-20 16:00:00"
  }
}
```

**功能特性：**
- ✅ 自动计算文件MD5，支持秒传（相同文件不重复上传）
- ✅ 生成唯一文件名，避免文件名冲突
- ✅ 自动创建上传目录
- ✅ 文件信息自动保存到数据库
- ✅ 返回完整的访问URL：`http://localhost:8080/{uniqueFileName}`

### 2. 文件访问
**访问方式：** 直接通过URL访问

**URL格式：** `http://localhost:8080/{uniqueFileName}`

**示例：** `http://localhost:8080/abc123.jpg`

**说明：** 文件上传成功后，返回的 `url` 字段即为完整的访问地址，可直接在浏览器中打开或用于 `<img>` 标签的 `src` 属性。

### 3. 根据MD5查询文件（秒传检测）
**接口地址：** `GET /api/file/md5/{md5}`

**请求方式：** `GET`

**路径参数：**
| 参数名 | 类型   | 必填 | 说明      |
|--------|--------|------|-----------|
| md5    | String | 是   | 文件MD5值 |

**响应示例：**
```json
{
  "code": 200,
  "message": "操作成功",
  "data": {
    "id": 1,
    "fileName": "test.jpg",
    "url": "http://localhost:8080/abc123.jpg",
    ...
  }
}
```

### 4. 分页查询文件列表
**接口地址：** `GET /api/file/page`

**请求参数：**
| 参数名   | 类型    | 必填 | 默认值 | 说明         |
|----------|---------|------|--------|--------------|
| pageNum  | Integer | 否   | 1      | 页码         |
| pageSize | Integer | 否   | 10     | 每页数量     |
| fileName | String  | 否   | -      | 文件名（模糊查询） |
| type     | String  | 否   | -      | 文件类型     |
| enable   | Integer | 否   | -      | 启用状态     |

## 前端调用示例

### Vue3 + Element Plus 示例
```vue
<template>
  <div>
    <el-upload
      action="/api/file/upload"
      :headers="{ Authorization: token }"
      :on-success="handleSuccess"
      :on-error="handleError"
      :before-upload="beforeUpload"
    >
      <el-button type="primary">点击上传</el-button>
    </el-upload>
  </div>
</template>

<script setup>
import { ElMessage } from 'element-plus'

const token = localStorage.getItem('token')

const beforeUpload = (file) => {
  const isLt10M = file.size / 1024 / 1024 < 10
  if (!isLt10M) {
    ElMessage.error('上传文件大小不能超过 10MB!')
    return false
  }
  return true
}

const handleSuccess = (response) => {
  if (response.code === 200) {
    ElMessage.success('上传成功')
    console.log('文件URL:', response.data.url)
  } else {
    ElMessage.error(response.message)
  }
}

const handleError = () => {
  ElMessage.error('上传失败')
}
</script>
```

### Axios 示例
```javascript
import axios from 'axios'

// 文件上传
const uploadFile = (file) => {
  const formData = new FormData()
  formData.append('file', file)
  
  return axios.post('/api/file/upload', formData, {
    headers: {
      'Content-Type': 'multipart/form-data'
    }
  })
}

// 使用
const file = document.querySelector('input[type="file"]').files[0]
uploadFile(file).then(res => {
  console.log('文件URL:', res.data.data.url)
  // URL格式: http://localhost:8080/file/download/abc123.jpg
})
```

## 数据库存储说明

上传成功后，文件记录会保存到 `sys_file` 表：

| 字段       | 说明                                    | 示例值                                      |
|------------|----------------------------------------|---------------------------------------------|
| id         | 主键ID                                  | 1                                           |
| file_name  | 原始文件名                              | test.jpg                                    |
| type       | 文件类型                                | jpg                                         |
| size       | 文件大小（KB）                          | 1024                                        |
| url        | **完整访问URL**                         | http://localhost:8080/abc123.jpg |
| md5        | 文件MD5值                               | d41d8cd98f00b204e9800998ecf8427e            |
| enable     | 是否启用                                | 1                                           |
| create_time| 创建时间                                | 2025-11-20 16:00:00                         |

**重点：** `url` 字段存储的是完整的访问URL，格式为：`http://localhost:{port}/{uniqueFileName}`

## 静态资源映射说明

通过 `WebConfig` 配置了静态资源映射：
- 访问路径：`http://localhost:8080/{fileName}`
- 实际路径：`D:/upload/{fileName}`

这样文件可以直接通过根路径访问，无需额外的下载接口。

## 注意事项

1. **修改端口**：如果修改了 `server.port`，需要同步修改 `file.access-url` 中的端口号
2. **上传路径**：确保 `file.upload-path` 指定的目录有写入权限
3. **生产环境**：建议将 `localhost` 替换为实际的域名或IP地址
4. **文件安全**：建议添加文件类型白名单验证，防止上传恶意文件
